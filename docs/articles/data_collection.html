<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Collection • statbot</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Data Collection">
<meta property="og:description" content="statbot">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">statbot</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.1.2.20</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data_collection.html">Data Collection</a>
    </li>
    <li>
      <a href="../articles/spatialunits.html">Spatial Units</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="data_collection_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data Collection</h1>
            
      
      
      <div class="hidden name"><code>data_collection.Rmd</code></div>

    </div>

    
    
<div id="how-to-contribute-to-the-collection-of-data" class="section level1">
<h1 class="hasAnchor">
<a href="#how-to-contribute-to-the-collection-of-data" class="anchor"></a>How to contribute to the collection of data</h1>
<p>Hello, and thank you for joining the STATBOT-team! This documentation shows what steps have to be done to contribute to the collection of data. It also serves as a documentation for the different functions. This readme is work-in-progress: please help us by indicating which informations would be the most useful to you.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>You can start right away with R or python. The “main-script”" is written in R but executes all R and python source files in a cronjob-like manner.</p>
<div id="r" class="section level3">
<h3 class="hasAnchor">
<a href="#r" class="anchor"></a>R</h3>
<p>You can just open the R-project file statbot.Rproj. Then you have to initialize renv with renv::init(). Then you should be set-up and have the necessary packages. You can load <code><a href="https://devtools.r-lib.org/reference/load_all.html">devtools::load_all(".")</a></code> to have all the scripts in your environment for easier working.</p>
</div>
<div id="python" class="section level3">
<h3 class="hasAnchor">
<a href="#python" class="anchor"></a>Python</h3>
<p>For python there is a virtual environment under statbot_env that can be activated with <code>source stabot_env/bin/activate</code>. However it usually not works like this. At the moment we activate it and then still have to pip install all the packages: <code>pip install -r requirements.txt</code></p>
</div>
</div>
<div id="data-collection" class="section level2">
<h2 class="hasAnchor">
<a href="#data-collection" class="anchor"></a>Data Collection</h2>
<p>First of all, you can find a dataset that nobody is working on yet. You can find an <a href="https://github.com/statistikZH/statbot/projects/2">overview here</a>. There you can see on the kanban-board several columns. Just grab a dataset that is on the left side “to do” and move it to the second column “in progress”. Open the tasks and put your initials in brackets like [CR] so that we know who is working on that dataset.</p>
<p><img src="img/github_projects.PNG" alt="Github projects">.</p>
<p>At the moment of writing, the <a href="https://docs.google.com/spreadsheets/d/1LtExe4Kj0OVE8aGsfqLJnWiGtW6nqN1etqBBzpEDLoA/edit#gid=1224865549">best overview of the datasets is still on google sheets</a>. This is particularly important for the dataset-id (“class_id”) that has to be used in the code.</p>
<p>in R there is a function to initialize a template-script in the right folder “R”. Use the following command: <code><a href="../reference/download_dataset_init.html">download_dataset_init(dataset_id,author)</a></code>. The dataset_id you got from the above mentioned spread sheet and you just fill out your name as author.</p>
<p>Then the templates consists of several standard elements. Every dataset is named like the following: <code>statbot_src_3_02_001_CH</code>. It thus starts with statbot_src_ and then contains the dataset_id and ends with “CH” if the script is for the scope of Switzerland, or for example “ZH” if it is only for data from Zurich.</p>
<p>Every function has a parameter flag_force_update that if TRUE forces the function to execute. If it is FALSE there is the helper-function <code><a href="../reference/check_changes_in_input_file.html">check_changes_in_input_file(destfile)</a></code> that is executed (destfile being the file downloaded for this dataset). The helper-function makes a MD5-hash of the file to see whether there is a new file or whether this particular file has already been extracted. If new, then it includes the new hash as being more up-to-date into a hash-table under data/hashes.csv.</p>
<p>Then you can start with the data cleaning of that dataset. The aim is to get a “fact table” that contains the following variables (according to version 3 of our DB-schema):</p>
<div class="figure">
<img src="img/fact_table.PNG" alt=""><p class="caption">Fact Table</p>
</div>
</div>
<div id="metadata" class="section level2">
<h2 class="hasAnchor">
<a href="#metadata" class="anchor"></a>Metadata</h2>
<p>You should not forget to include the metadata for your dataset! The following to steps have to be made:</p>
<div id="inserting-a-new-class-in-the-classes-overview" class="section level3">
<h3 class="hasAnchor">
<a href="#inserting-a-new-class-in-the-classes-overview" class="anchor"></a>Inserting a new class in the classes overview</h3>
<p>The following script programmatically generates the file data/classes.csv that contains all the metadata about the datasets: R/create_classes.R . In this script you will see blocks of code like the following:</p>
<p><img src="img/create_classes.PNG" alt="Create Classes">.</p>
<p>Just copy one and change the data.frame-name and the class_id to your new id that ouve’got from the spread sheet menioned previously. Adapt all the other information to your dataset. You might find your ID also in comments like here: <code>#'population_density': '1_01_002',</code> Here it shows the class_name as well, which is the second parameter. This class_name is configurated in english and is a variable value that is not human-readable. All the other Names and Descriptions are meant to be human-readable elements. If you have questions come to us.</p>
<p>Then there is a file that generates the dimensions.csv file: R/create_dimensions.R</p>
<p>Every dimension like sex, age, origin has an own dim_id and contains some meta-data about the dimension itself as well as about the values that are used. Please check first whether the dimension you want to use is already there. The dimension_id is then necessary to fill in for the classes created in the script mentioned before. The unique_name is a variable_name in English to be used in your fact-table. We were advised to use human-readable column names this is why we do not use dim_ids anymore (since V3 of the DB-schema).</p>
<p><img src="img/create_dimensions.PNG" alt="Create Dimensions">.</p>
</div>
</div>
<div id="continuing-with-the-data-cleaning-" class="section level2">
<h2 class="hasAnchor">
<a href="#continuing-with-the-data-cleaning-" class="anchor"></a>Continuing with the data cleaning.</h2>
<p>The current_id is on Swiss federal level the “BFS-NR” used for communes, districts and cantons. If you are working on regional data, you would have here your own ids. But they have to be converted to hist_ids with the function <code><a href="../reference/convert_current_to_hist_id.html">convert_current_to_hist_id(df, reference_point)</a></code>. The FSO itself has for communes and districts a hist-id, which we generated in the create_spatial_units.R file that is explained here. It creates a csv-table spatialunits.csv that contains current_id, hist_id, ontologies and dates of validity.</p>
<p>In order to run that function you need three elements (two parameters). You need to have defined a dataframe already that consists a column spatialunit_current_id with the above mentioned id. And you need a colum with the spatialunit_ontology e.g. “A.ADM3” for communes (see please the documentation here for a list of ontologies used). These two elements are just given into the function as a dataframe. The last element needed is the day of validity for the spatial data in that dataset (“reference_point”). The parameter is given in the character-format like “1.12.2021” (day.month.year). The function that is going to filter all elements that were valid that day (imagine two communes merging: if they merges on 1.6.2021 then they are not the same anymore than on 1.12.2021…). The output of this function is a column with the hist_ids. You should check how many NAs were generated, in order to see if important bugfixging is necessary. Without a hist_id there would be an important unique_id missing for those elements.</p>
<p>After writing the file out in the data/values folder (in the same logic with your class-id as name) you can execute the function <code><a href="../reference/update_last_updated.html">update_last_updated(class_id)</a></code> so that the classes.csv has a value correctly set for the last update on that class.</p>
</div>
<div id="converting-per-capita-per-area" class="section level2">
<h2 class="hasAnchor">
<a href="#converting-per-capita-per-area" class="anchor"></a>Converting per capita, per area</h2>
<p>For this the function <code><a href="../reference/convert_and_write_per_unit.html">convert_and_write_per_unit(df,file_name,how_many=1000,type="pop",simplify_date=F)</a></code> can be used. A data_frame is given in that is then converted and written out (in file_name). If you say pop then it divides by the population, is you say area it divides by the area. How_many indicates if it is for example per 1000 inhabitants (how_many=1000) or if it is per habitants it has to be set to how_many=1. Simplify_date helps in case that the values do not match perfectly for example 31.12.2020 and 31.03.2020. It takes only the year value (in the case here 2020).</p>
<p>The function ends with returning “UPDATE OK” if everything went well.</p>
</div>
<div id="translating-ids-into-names" class="section level2">
<h2 class="hasAnchor">
<a href="#translating-ids-into-names" class="anchor"></a>Translating ids into names</h2>
<p>If you have for example a dataset with only ids and need a name, then you can use the function <code><a href="../reference/translate_to_spatial_unit_name.html">translate_to_spatial_unit_name(df, language)</a></code> and give in hist_ids and a language (“de”,“fr”,“it”,“en”) and it gives you the values that are specified in the spatial unit table.</p>
</div>
<div id="adding-values-to-higher-granularity-values" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-values-to-higher-granularity-values" class="anchor"></a>Adding values to higher granularity values</h2>
<p>The function <code>add_granularity_levels_up&lt;-function(df,list_ontologies)</code> provides an easy mean to sum up values of A.ADM3 level to higher levels A.ADM2, A.ADM1 and CH. However, not to any other at the moment (e.g. regions in ZH, or to have as a base any A.ADM4).</p>
</div>
<div id="adding-higher-granularity-values" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-higher-granularity-values" class="anchor"></a>Adding higher granularity values</h2>
<p>The function <code>add_granularity_levels_up&lt;-function(df,list_ontologies,list_dimensions=NULL)</code> adds your communal data up to higher levels (district, cantonal or Switzerland - other levels such as regions not supported yet). You can select granularities by e.g. <code>list_ontologies=c("A.ADM2","A.ADM1","CH")</code>. You add a list of dimensions for the correct grouping within the df, such as <code>list_dimensions=c("gender","economic_sector"))</code>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Thomas Knecht, Thomas Lo Russo, Pauline Maury Laribière, Hester Pieters, Christian Ruiz, Jorin Steiger.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
